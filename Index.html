<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Kimberly & Lorenzo‚Äôs Magical Dragon Quest</title>
<link rel="icon" href="favicon.ico" sizes="any">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;700;900&display=swap" rel="stylesheet">
<!-- Preload critical art for instant first paint -->
<link rel="preload" as="image" href="images/cover.webp" imagesrcset="images/cover.webp 1x, images/cover@2x.webp 2x" imagesizes="(max-width: 900px) 100vw, 900px">
<link rel="preload" as="image" href="images/forest_meet.webp" imagesrcset="images/forest_meet.webp 1x, images/forest_meet@2x.webp 2x" imagesizes="(max-width: 900px) 100vw, 900px">
<style>
  :root{--bg:#fffaf4;--card:#ffffff;--text:#2c2c2c;--accent:#6b5cff;--accent2:#ff6bb0}
  *{box-sizing:border-box}
  body{margin:0;font-family:'Nunito',system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
       background: radial-gradient(1200px 800px at 20% -10%, #fff3dd, transparent),
                   radial-gradient(1000px 700px at 120% 10%, #ffe6f2, transparent), var(--bg);color:var(--text)}
  .wrap{max-width:960px;margin:20px auto;padding:12px}
  .title{font-size:28px;font-weight:900;margin:8px 4px 14px;display:flex;gap:8px;align-items:center}
  .badge{font-size:12px;font-weight:800;color:#fff;background:linear-gradient(135deg,var(--accent),var(--accent2));
         padding:6px 10px;border-radius:999px}
  .card{background:var(--card);border-radius:24px;box-shadow:0 10px 30px rgba(0,0,0,.08);padding:16px;position:relative;overflow:hidden}
  .scene{width:100%;aspect-ratio:16/9;border-radius:18px;overflow:hidden;border:4px solid #fff;box-shadow:0 8px 20px rgba(0,0,0,.06);position:relative}
  .scene picture, .scene img{width:100%;height:100%;object-fit:cover;display:block}
  .fade{opacity:0;transition:opacity .6s ease}
  .fade.show{opacity:1}
  .loading-overlay{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;background:#0000;pointer-events:none}
  .sparkle{position:absolute;width:6px;height:6px;border-radius:50%;background:radial-gradient(circle,#ffd76a 0%,#ffd76a 40%,transparent 70%);opacity:.0;animation: twinkle 2.2s infinite ease-in-out}
  @keyframes twinkle{0%,100%{opacity:0;transform:translateY(0) scale(.7)}50%{opacity:.9;transform:translateY(-8px) scale(1)}}
  .text{font-size:20px;line-height:1.55;font-weight:700;margin:12px 4px}
  .choices{display:grid;grid-template-columns:1fr;gap:10px;margin-top:8px}
  .btn{font-size:18px;font-weight:800;padding:14px 18px;border-radius:14px;border:none;cursor:pointer;
       background:#f4f3ff;color:#2d2a65;box-shadow:0 6px 14px rgba(107,92,255,.22);transition:transform .08s ease, box-shadow .2s ease, background .2s ease}
  .btn:hover{transform:translateY(-1px)} .btn:active{transform:translateY(1px)}
  .primary{background:linear-gradient(135deg,var(--accent),var(--accent2));color:#fff;box-shadow:0 8px 18px rgba(255,107,176,.35)}
  .bar{display:flex;gap:8px;align-items:center;justify-content:space-between;margin-top:10px;flex-wrap:wrap}
  .small{font-size:14px;background:#ffe9f3;color:#6f2854;padding:8px 10px;border-radius:999px;border:none;cursor:pointer}
  .footer{text-align:center;color:#6b6b6b;font-size:14px;margin-top:16px}
  @media (min-width:700px){.choices{grid-template-columns:1fr 1fr}}
</style>
</head>
<body>
  <div class="wrap">
    <div class="title">Kimberly & Lorenzo‚Äôs Magical Dragon Quest <span class="badge">Interactive</span></div>

    <div class="card">
      <!-- Loading screen (shows until first scene ready) -->
      <div id="loading" class="scene fade show" aria-hidden="false">
        <picture>
          <source srcset="images/loading.webp" type="image/webp">
          <img src="images/loading.png" alt="Loading the magical forest..." />
        </picture>
        <div class="loading-overlay" id="sparkles"></div>
      </div>

      <!-- Main scene -->
      <div id="stage" class="fade" aria-live="polite" aria-busy="true" hidden>
        <div class="scene">
          <picture id="art">
            <source id="artWebp" type="image/webp">
            <img id="artPng" alt="Illustrated scene" loading="eager" />
          </picture>
        </div>
        <div id="sceneText" class="text"></div>
        <div id="choices" class="choices"></div>
        <div class="bar">
          <button id="readBtn" class="btn primary">üîä Read Aloud</button>
          <button id="stopBtn" class="small">Stop</button>
          <button id="restartBtn" class="small">Restart</button>
        </div>
        <audio id="narration" preload="auto"></audio>
        <audio id="flip" preload="auto" src="audio/pageflip.mp3"></audio>
      </div>
    </div>

    <div class="footer">Read Aloud uses MP3 narration if present; falls back to a calm male voice.</div>
  </div>

<script>
/* -------------------- SCENES (paths point to optimised images) -------------------- */
const scenes = {
  cover:        { text:"Welcome! Tap to begin the adventure of Kimberly, Lorenzo, and a very helpful baby dragon.", image:"cover",        audio:"cover"        , options:[{label:"Start Adventure", next:"forest_meet"}] },
  forest_meet:  { text:"In the Whispering Forest, a baby dragon swoops down: ‚ÄúHelp! My mama is missing!‚Äù",          image:"forest_meet",  audio:"forest_meet"  , options:[{label:"Follow the baby dragon", next:"follow_dragon"},{label:"Check Lorenzo‚Äôs magic book", next:"check_book"}]},
  follow_dragon:{ text:"They follow the dragon between golden trees. Sparkles float like tiny stars.",               image:"follow_dragon",audio:"follow_dragon", options:[{label:"Keep following", next:"patatan_dance"},{label:"Call out for Mama Dragon", next:"cave_mouth"}]},
  check_book:   { text:"Lorenzo opens his magic book. A glowing map shows a cave and a floating island.",           image:"check_book",   audio:"check_book"   , options:[{label:"Take the meadow path", next:"meadow"},{label:"Ride the clouds to the island", next:"clouds_ride"}]},
  patatan_dance:{ text:"In the meadow, a tanned one-year-old named Patatan wiggles and claps‚Äîletters glitter: ‚ÄúHappy hearts unlock magic!‚Äù", image:"patatan_dance", audio:"patatan_dance", options:[{label:"Save the spell for later", next:"river_bridge"},{label:"Use the happy spell now", next:"crystal_puzzle"}]},
  meadow:       { text:"They cross a rainbow meadow. Butterflies twirl like confetti.",                             image:"meadow",       audio:"meadow",       options:[{label:"Head to the river bridge", next:"river_bridge"},{label:"Look for the cave entrance", next:"cave_mouth"}]},
  river_bridge: { text:"At the giggly river, a friendly bridge asks: ‚ÄúDo you promise to be kind?‚Äù",                 image:"river_bridge", audio:"river_bridge", options:[{label:"Yes, we promise!", next:"clouds_ride"},{label:"Tell a kind story", next:"cave_mouth"}]},
  clouds_ride:  { text:"They ride on fluffy clouds. The baby dragon points to a floating island!",                  image:"clouds_ride",  audio:"clouds_ride",  options:[{label:"Land on the island", next:"island"},{label:"Peek from the clouds", next:"cave_mouth"}]},
  island:       { text:"A Shadow Witch waves shyly. She isn‚Äôt scary‚Äîjust lonely. She offers to help.",              image:"island",       audio:"island",       options:[{label:"Hug the witch", next:"cave_mouth"},{label:"Ask for a clue", next:"cave_mouth"}]},
  cave_mouth:   { text:"They find the crystal cave hidden behind laughing vines.",                                  image:"cave_mouth",   audio:"cave_mouth",   options:[{label:"Slip under the vines", next:"crystal_puzzle"},{label:"Ask Patatan to dance the vines away", next:"crystal_puzzle"}]},
  crystal_puzzle:{text:"Inside, a crystal puzzle sparkles. ‚ÄúMatch the shapes!‚Äù says a gentle voice.",               image:"crystal_puzzle",audio:"crystal_puzzle",options:[{label:"Match circles", next:"crystal_dome"},{label:"Match stars", next:"crystal_dome"}]},
  crystal_dome: { text:"Mama Dragon rests inside a crystal dome‚Äîsafe but stuck.",                                   image:"crystal_dome", audio:"crystal_dome", options:[{label:"Tickle the crystal with magic", next:"rescue"},{label:"Sing a lullaby together", next:"rescue"}]},
  rescue:       { text:"The dome melts into harmless sparkles. Mama Dragon is free! The cave glows with happy light.", image:"rescue",     audio:"rescue",       options:[{label:"Celebrate!", next:"lair_tea"}]},
  lair_tea:     { text:"Back at the cozy dragon lair, everyone shares warm tea (and tiny dragon-cookies!).",        image:"lair_tea",     audio:"lair_tea",     options:[{label:"Open the gifts!", next:"party_gifts"}]},
  party_gifts:  { text:"Hooray! Kimberly gets a starglow locket, Lorenzo a whispering bookmark, the dragons wing-warmers, and Patatan a musical rattle!", image:"party_gifts", audio:"party_gifts", options:[{label:"Play again", next:"forest_meet"},{label:"Back to cover", next:"cover"}]}
};

/* --------------- Stage elements --------------- */
const stage      = document.getElementById('stage');
const loading    = document.getElementById('loading');
const sparkles   = document.getElementById('sparkles');
const art        = document.getElementById('art');
const artWebp    = document.getElementById('artWebp');
const artPng     = document.getElementById('artPng');
const sceneText  = document.getElementById('sceneText');
const choicesEl  = document.getElementById('choices');
const readBtn    = document.getElementById('readBtn');
const stopBtn    = document.getElementById('stopBtn');
const restartBtn = document.getElementById('restartBtn');
const narration  = document.getElementById('narration');
const flip       = document.getElementById('flip');

let current = 'cover';

/* Sparkle overlay during loading */
(function makeSparkles(){
  for(let i=0;i<22;i++){
    const s=document.createElement('div');
    s.className='sparkle';
    s.style.left = Math.random()*100+'%';
    s.style.top  = (10+Math.random()*80)+'%';
    s.style.animationDelay = (Math.random()*2)+'s';
    sparkles.appendChild(s);
  }
})();

/* Calm male TTS preference */
function pickCalmMaleVoice(){
  if (!window.speechSynthesis) return null;
  const voices = window.speechSynthesis.getVoices() || [];
  const preferredNames = ["Daniel","George","Guy","Matthew","Brian","Arthur","James","Christopher","Alex","Hugh"];
  const best = voices.find(v => (v.lang||'').toLowerCase().startsWith('en-gb') && preferredNames.some(n=>v.name.toLowerCase().includes(n.toLowerCase())));
  return best || voices.find(v => (v.lang||'').toLowerCase().startsWith('en-gb'))
              || voices.find(v => (v.lang||'').toLowerCase().startsWith('en-')) || null;
}
function stopAll(){
  narration.pause(); narration.currentTime=0;
  if (window.speechSynthesis) window.speechSynthesis.cancel();
}
function speakTTS(text){
  if (!window.speechSynthesis) return;
  const u = new SpeechSynthesisUtterance(text.replace(/([.!?])\s/g,"$1  "));
  const v = pickCalmMaleVoice(); if (v) u.voice=v;
  u.rate=0.92; u.pitch=0.98; u.volume=1;
  window.speechSynthesis.cancel();
  window.speechSynthesis.speak(u);
}

/* Load scene art with WebP first, PNG fallback */
function setArtBase(name){
  artWebp.srcset = `images/${name}.webp 1x, images/${name}@2x.webp 2x`;
  artPng.src = `images/${name}.png`;
  artPng.loading = (name==='cover' || name==='forest_meet') ? 'eager' : 'lazy';
}

/* Render a scene */
function render(){
  const s = scenes[current]; if (!s) return;
  setArtBase(s.image);
  sceneText.textContent = s.text;
  choicesEl.innerHTML='';
  s.options.forEach(opt=>{
    const b=document.createElement('button');
    b.className='btn';
    b.textContent=opt.label;
    b.onclick=()=>{ stopAll(); flip.currentTime=0; flip.play().catch(()=>{}); current=opt.next; render(); };
    choicesEl.appendChild(b);
  });
}

/* Show stage after cover preloads */
function showStage(){
  loading.classList.remove('show');
  setTimeout(()=>{
    loading.hidden = true;
    stage.hidden = false;
    requestAnimationFrame(()=> stage.classList.add('show'));
  }, 300);
}

/* Controls */
readBtn.addEventListener('click', async ()=>{
  const s = scenes[current];
  stopAll();
  // Try MP3 first
  if (s && s.audio){
    narration.src = `audio/${s.audio}.mp3`;
    try { await narration.play(); return; } catch(e){}
  }
  // Fallback to TTS
  speakTTS(s.text);
});
stopBtn.addEventListener('click', stopAll);
restartBtn.addEventListener('click', ()=>{ stopAll(); current='cover'; render(); });

/* Init */
render();
/* Simulate quick load ‚Üí reveal stage with fade */
window.addEventListener('load', ()=> setTimeout(showStage, 600));
if (window.speechSynthesis) window.speechSynthesis.onvoiceschanged = ()=>{};
</script>
</body>
</html>
