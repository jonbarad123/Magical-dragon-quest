<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Kimberly & Lorenzoâ€™s Magical Dragon Quest</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;700;900&display=swap" rel="stylesheet">
<style>
  :root{--bg:#fffaf4;--card:#ffffff;--text:#2c2c2c;--accent:#6b5cff;--accent2:#ff6bb0}
  *{box-sizing:border-box}
  body{margin:0;font-family:'Nunito',system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
       background: radial-gradient(1200px 800px at 20% -10%, #fff3dd, transparent),
                   radial-gradient(1000px 700px at 120% 10%, #ffe6f2, transparent), var(--bg);color:var(--text)}
  .wrap{max-width:960px;margin:20px auto;padding:12px}
  .title{font-size:28px;font-weight:900;margin:8px 4px 14px;display:flex;gap:8px;align-items:center}
  .badge{font-size:12px;font-weight:800;color:#fff;background:linear-gradient(135deg,var(--accent),var(--accent2));
         padding:6px 10px;border-radius:999px}
  .card{background:var(--card);border-radius:24px;box-shadow:0 10px 30px rgba(0,0,0,.08);padding:16px}
  .scene{width:100%;aspect-ratio:16/9;border-radius:18px;overflow:hidden;border:4px solid #fff;box-shadow:0 8px 20px rgba(0,0,0,.06)}
  .scene img{width:100%;height:100%;object-fit:cover;display:block}
  .text{font-size:20px;line-height:1.55;font-weight:700;margin:12px 4px}
  .choices{display:grid;grid-template-columns:1fr;gap:10px;margin-top:8px}
  .btn{font-size:18px;font-weight:800;padding:14px 18px;border-radius:14px;border:none;cursor:pointer;
       background:#f4f3ff;color:#2d2a65;box-shadow:0 6px 14px rgba(107,92,255,.22);transition:transform .08s ease,box-shadow .2s ease,background .2s ease}
  .btn:hover{transform:translateY(-1px)} .btn:active{transform:translateY(1px)}
  .primary{background:linear-gradient(135deg,var(--accent),var(--accent2));color:#fff;box-shadow:0 8px 18px rgba(255,107,176,.35)}
  .bar{display:flex;gap:8px;align-items:center;justify-content:space-between;margin-top:10px;flex-wrap:wrap}
  .small{font-size:14px;background:#ffe9f3;color:#6f2854;padding:8px 10px;border-radius:999px;border:none;cursor:pointer}
  .footer{text-align:center;color:#6b6b6b;font-size:14px;margin-top:16px}
  @media (min-width:700px){.choices{grid-template-columns:1fr 1fr}}
</style>
</head>
<body>
  <div class="wrap">
    <div class="title">Kimberly & Lorenzoâ€™s Magical Dragon Quest <span class="badge">Interactive</span></div>
    <div class="card">
      <div class="scene"><img id="sceneImg" alt="Illustrated scene"></div>
      <div id="sceneText" class="text"></div>
      <div id="choices" class="choices"></div>
      <div class="bar">
        <button id="readBtn" class="btn primary">ðŸ”Š Read Aloud</button>
        <button id="stopBtn" class="small">Stop</button>
        <button id="restartBtn" class="small">Restart</button>
      </div>
      <audio id="narration" preload="auto"></audio>
    </div>
    <div class="footer">Uses recorded narration if available â€¢ Falls back to calm male TTS</div>
  </div>

<script>
/* -------------------- SCENES (with human audio filenames) -------------------- */
const scenes = {
  cover: {
    text: "Welcome! Tap to begin the adventure of Kimberly, Lorenzo, and a very helpful baby dragon.",
    image: "images/cover.png",
    audio: "audio/cover.mp3",
    options: [{label:"Start Adventure", next:"forest_meet"}]
  },
  forest_meet: {
    text: "In the Whispering Forest, a baby dragon swoops down: â€œHelp! My mama is missing!â€",
    image: "images/forest_meet.png",
    audio: "audio/forest_meet.mp3",
    options: [
      {label:"Follow the baby dragon", next:"follow_dragon"},
      {label:"Check Lorenzoâ€™s magic book", next:"check_book"}
    ]
  },
  follow_dragon: {
    text: "They follow the dragon between golden trees. Sparkles float like tiny stars.",
    image: "images/follow_dragon.png",
    audio: "audio/follow_dragon.mp3",
    options: [
      {label:"Keep following", next:"patatan_dance"},
      {label:"Call out for Mama Dragon", next:"cave_mouth"}
    ]
  },
  check_book: {
    text: "Lorenzo opens his magic book. A glowing map shows a cave and a floating island.",
    image: "images/check_book.png",
    audio: "audio/check_book.mp3",
    options: [
      {label:"Take the meadow path", next:"meadow"},
      {label:"Ride the clouds to the island", next:"clouds_ride"}
    ]
  },
  patatan_dance: {
    text: "In the meadow, a tanned one-year-old named Patatan wiggles and clapsâ€”letters glitter: â€œHappy hearts unlock magic!â€",
    image: "images/patatan_dance.png",
    audio: "audio/patatan_dance.mp3",
    options: [
      {label:"Save the spell for later", next:"river_bridge"},
      {label:"Use the happy spell now", next:"crystal_puzzle"}
    ]
  },
  meadow: {
    text: "They cross a rainbow meadow. Butterflies twirl like confetti.",
    image: "images/meadow.png",
    audio: "audio/meadow.mp3",
    options: [
      {label:"Head to the river bridge", next:"river_bridge"},
      {label:"Look for the cave entrance", next:"cave_mouth"}
    ]
  },
  river_bridge: {
    text: "At the giggly river, a friendly bridge asks: â€œDo you promise to be kind?â€",
    image: "images/river_bridge.png",
    audio: "audio/river_bridge.mp3",
    options: [
      {label:"Yes, we promise!", next:"clouds_ride"},
      {label:"Tell a kind story", next:"cave_mouth"}
    ]
  },
  clouds_ride: {
    text: "They ride on fluffy clouds. The baby dragon points to a floating island!",
    image: "images/clouds_ride.png",
    audio: "audio/clouds_ride.mp3",
    options: [
      {label:"Land on the island", next:"island"},
      {label:"Peek from the clouds", next:"cave_mouth"}
    ]
  },
  island: {
    text: "A Shadow Witch waves shyly. She isnâ€™t scaryâ€”just lonely. She offers to help.",
    image: "images/island.png",
    audio: "audio/island.mp3",
    options: [
      {label:"Hug the witch", next:"cave_mouth"},
      {label:"Ask for a clue", next:"cave_mouth"}
    ]
  },
  cave_mouth: {
    text: "They find the crystal cave hidden behind laughing vines.",
    image: "images/cave_mouth.png",
    audio: "audio/cave_mouth.mp3",
    options: [
      {label:"Slip under the vines", next:"crystal_puzzle"},
      {label:"Ask Patatan to dance the vines away", next:"crystal_puzzle"}
    ]
  },
  crystal_puzzle: {
    text: "Inside, a crystal puzzle sparkles. â€œMatch the shapes!â€ says a gentle voice.",
    image: "images/crystal_puzzle.png",
    audio: "audio/crystal_puzzle.mp3",
    options: [
      {label:"Match circles", next:"crystal_dome"},
      {label:"Match stars", next:"crystal_dome"}
    ]
  },
  crystal_dome: {
    text: "Mama Dragon rests inside a crystal domeâ€”safe but stuck.",
    image: "images/crystal_dome.png",
    audio: "audio/crystal_dome.mp3",
    options: [
      {label:"Tickle the crystal with magic", next:"rescue"},
      {label:"Sing a lullaby together", next:"rescue"}
    ]
  },
  rescue: {
    text: "The dome melts into harmless sparkles. Mama Dragon is free! The cave glows with happy light.",
    image: "images/rescue.png",
    audio: "audio/rescue.mp3",
    options: [{label:"Celebrate!", next:"lair_tea"}]
  },
  lair_tea: {
    text: "Back at the cozy dragon lair, everyone shares warm tea (and tiny dragon-cookies!).",
    image: "images/lair_tea.png",
    audio: "audio/lair_tea.mp3",
    options: [{label:"Open the gifts!", next:"party_gifts"}]
  },
  party_gifts: {
    text: "Hooray! Kimberly gets a starglow locket, Lorenzo a whispering bookmark, the dragons wing-warmers, and Patatan a musical rattle!",
    image: "images/party_gifts.png",
    audio: "audio/party_gifts.mp3",
    options: [
      {label:"Play again", next:"forest_meet"},
      {label:"Back to cover", next:"cover"}
    ]
  }
};

/* -------------------- Player: MP3 first, TTS fallback -------------------- */
const sceneImg = document.getElementById('sceneImg');
const sceneText = document.getElementById('sceneText');
const choicesEl = document.getElementById('choices');
const readBtn = document.getElementById('readBtn');
const stopBtn = document.getElementById('stopBtn');
const restartBtn = document.getElementById('restartBtn');
const narrationEl = document.getElementById('narration');

let current = 'cover';
let ttsUtterance = null;

function render(){
  const s = scenes[current];
  sceneImg.src = s.image;
  sceneText.textContent = s.text;
  choicesEl.innerHTML = '';
  s.options.forEach(opt=>{
    const b = document.createElement('button');
    b.className = 'btn';
    b.textContent = opt.label;
    b.onclick = ()=>{ stopAll(); current = opt.next; render(); };
    choicesEl.appendChild(b);
  });
}

function stopAll(){
  // Stop MP3
  narrationEl.pause();
  narrationEl.currentTime = 0;
  // Stop TTS
  if (window.speechSynthesis) window.speechSynthesis.cancel();
  ttsUtterance = null;
}

function pickCalmMaleVoice(){
  if (!window.speechSynthesis) return null;
  const voices = window.speechSynthesis.getVoices() || [];
  // Prefer calm male UK/US voices by common names or "male" hint
  const preferredNames = ["Daniel","George","Guy","Matthew","Brian","Arthur","James","Christopher","Alex","Hugh"];
  const candidates = voices.filter(v =>
    (v.lang && (v.lang.toLowerCase().startsWith('en-gb') || v.lang.toLowerCase().startsWith('en-us'))) &&
    (preferredNames.some(n => (v.name || "").toLowerCase().includes(n.toLowerCase())) ||
     (v.name || "").toLowerCase().includes("male"))
  );
  return candidates[0] || voices.find(v => v.lang?.toLowerCase().startsWith('en-gb')) ||
         voices.find(v => v.lang?.toLowerCase().startsWith('en-')) || null;
}

function speakTTS(text){
  if (!window.speechSynthesis) return;
  const u = new SpeechSynthesisUtterance(text);
  const v = pickCalmMaleVoice();
  if (v) u.voice = v;
  u.rate = 0.92;   // slightly slower, storybook pace
  u.pitch = 0.98;  // calm/deeper tone
  u.volume = 1.0;
  // Gentle pauses
  u.text = text.replace(/([.!?])\s/g, "$1  ");
  window.speechSynthesis.cancel();
  window.speechSynthesis.speak(u);
  ttsUtterance = u;
}

async function playNarration(){
  stopAll();
  const s = scenes[current];
  if (!s) return;
  // Try MP3 first
  if (s.audio) {
    narrationEl.src = s.audio;
    try {
      await narrationEl.play();
      return; // playing human audio
    } catch(e) {
      // MP3 failed (not present or autoplay blocked) -> fall back to TTS
    }
  }
  // TTS fallback
  speakTTS(s.text);
}

readBtn.addEventListener('click', playNarration);
stopBtn.addEventListener('click', stopAll);
restartBtn.addEventListener('click', ()=>{ stopAll(); current = 'cover'; render(); });

// Some browsers load voices async; calling once helps populate voices list
if (window.speechSynthesis) {
  window.speechSynthesis.onvoiceschanged = () => {};
}

render();
</script>
</body>
</html>
